name: Amplify Nightly Repeated Unit Test
on:
  workflow_dispatch:
  schedule:
    - cron: '30 1 * * *'
  push:
    branches:
      - chore/fix-nightly-repeated-test

permissions:
    contents: read

concurrency:
  group: ${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  unit_tests:
    name: ${{ matrix.scheme }} Repeated Unit Tests
    strategy:
      fail-fast: false
      matrix:
        scheme: [
          Amplify,
          AWSPluginsCore,
          AWSAPIPlugin,
          AWSCloudWatchLoggingPlugin,
          AWSCognitoAuthPlugin,
          AWSDataStorePlugin,
          AWSLocationGeoPlugin,
          AWSPredictionsPlugin,
          AWSPinpointAnalyticsPlugin,
          AWSPinpointPushNotificationsPlugin,
          AWSS3StoragePlugin,
          CoreMLPredictionsPlugin,
          InternalAWSPinpointUnitTests
        ]
    uses: ./.github/workflows/run_unit_tests_platforms.yml
    with:
      scheme: ${{ matrix.scheme }}
      timeout-minutes: 120
      generate_coverage_report: false
      test_iterations_flags: -test-iterations 5 -parallel-testing-enabled NO
        -skip-testing AWSDataStoreCategoryPluginTests/StorageEngineTestsSQLiteIndex 
        -skip-testing CoreMLPredictionsPluginUnitTests/CoreMLNaturalLanguageAdapterTests/testEntityToken 
        -skip-testing CoreMLPredictionsPluginUnitTests/CoreMLNaturalLanguageAdapterTests/testSyntaxToken 
        -skip-testing InternalAWSPinpointUnitTests/EventRecorderTests/testSubmitAllEvents_withActiveAndStoppedSessions_shouldGenerateRightInput 
        -skip-testing InternalAWSPinpointUnitTests/EndpointClientTests
        -skip-testing InternalAWSPinpointUnitTests/SessionClientTests 
        -skip-testing InternalAWSPinpointUnitTests/AnalyticsClientTests/testRecord_shouldAddGlobalAttributesAndMetrics 
        -skip-testing InternalAWSPinpointUnitTests/AnalyticsEventStorageTests
        -skip-testing InternalAWSPinpointUnitTests/PinpointClientTypesCodableTests/testCodableTypes_shouldEncodeAndDecodeSuccesfully 
        -skip-testing AWSS3StoragePluginTests/AWSS3StorageDownloadDataOperationTests/testDownloadDataOperationDownloadDataFailed 
        -skip-testing AWSS3StoragePluginTests/DefaultStorageTransferDatabaseTests/testLoadPersistableTasks 
        -skip-testing AWSS3StoragePluginTests/DefaultStorageTransferDatabaseTests/testPrepareForBackground 
        -skip-testing AWSS3StoragePluginTests/AWSS3StorageUploadFileOperationTests
        -skip-testing AWSS3StoragePluginTests/AWSS3StorageUploadDataOperationTests
        -skip-testing AWSPinpointPushNotificationsPluginUnitTests/AWSPinpointPushNotificationsPluginConfigureTests/testPluginKey
        -skip-testing AWSPinpointPushNotificationsPluginUnitTests/AWSPinpointPushNotificationsPluginConfigureTests/testConfigure_withNotificationsPermissionsDenied_shouldReportFailureToHub
        -skip-testing AWSPinpointAnalyticsPluginUnitTests/AWSPinpointAnalyticsPluginClientBehaviorTests/testIdentifyUserDispatchesErrorForPinpointError 
        -skip-testing AWSPinpointAnalyticsPluginUnitTests/AWSPinpointAnalyticsPluginClientBehaviorTests/testRecordEventWithNameDispatchesErrorForPinpointError 
        -skip-testing AWSPinpointAnalyticsPluginUnitTests/AWSPinpointAnalyticsPluginClientBehaviorTests/testRecordEventWithName
        -skip-testing AWSDataStoreCategoryPluginTests/MutationEventExtensionsTest
        -skip-testing AWSDataStoreCategoryPluginTests/ObserveQueryTaskRunnerTests
        -skip-testing AWSDataStoreCategoryPluginTests/OutgoingMutationQueueTests/testMutationQueueCreateSendsSync 
        -skip-testing AWSDataStoreCategoryPluginTests/OutgoingMutationQueueTests/testMutationQueueDeliversPendingMutationsFirst 
        -skip-testing AWSDataStoreCategoryPluginTests/LocalSubscriptionTests/testObserve 
        -skip-testing AWSDataStoreCategoryPluginTests/AWSDataStoreLocalStoreTests
        -skip-testing AWSDataStoreCategoryPluginTests/SyncMutationToCloudOperationTests/testRetryOnChangeReachability 
        -skip-testing AWSCognitoAuthPluginUnitTests/AWSCognitoAuthPluginAmplifyOutputsConfigTests
        -skip-testing AWSCognitoAuthPluginUnitTests/AWSAuthSignOutTaskTests
        -skip-testing AWSCognitoAuthPluginUnitTests/AWSAuthResendSignUpCodeAPITests/testResendSignupCodeWithEmptyUsername
        -skip-testing AWSCognitoAuthPluginUnitTests/StateMachineListenerTests/testOrderOfSubsription
        -skip-testing AWSCognitoAuthPluginUnitTests/AWSAuthSignInPluginTests/testSignInWithInvalidResult 
        -skip-testing AWSCognitoAuthPluginUnitTests/AWSCognitoAuthPluginConfigTests
        -skip-testing AWSCloudWatchLoggingPluginTests/AWSCloudWatchLoggingMonitorTests/testDelegateIsInvokedOnInterval 
        -skip-testing AWSCloudWatchLoggingPluginTests/AWSCloudWatchLoggingSessionControllerTests/testConsumeFailureSendsHubEvent 
        -skip-testing AWSAPIPluginTests/AppSyncRealTimeClientTests
        -skip-testing AWSAPIPluginTests/AppSyncListProviderTests
        -skip-testing AWSAPIPluginTests/GraphQLSubscribeTests
        -skip-testing AWSAPIPluginTests/AWSGraphQLOperationTests/testOperationCleanup 
        -skip-testing AWSAPIPluginTests/GraphQLSubscribeCombineTests/testMixedSuccessAndErrorValues 
        -skip-testing AWSAPIPluginTests/GraphQLSubscribeCombineTests/testMultipleSuccessValues
        -skip-testing AWSAPIPluginTests/GraphQLSubscribeTasksTests/testDecodingError
        -skip-testing AWSAPIPluginTests/AWSAPICategoryPluginRESTClientBehaviorTests
        -skip-testing AWSPluginsCoreTests/WebSocketClientTests/testAutoRetry_whenReceiveTransientFailureFromServer
        -skip-testing AmplifyTests/AmplifyTaskTests/testLongOperationWithPublishers
      test_without_building: true
      retry_tests: false
