name: Amplify Nightly Repeated Unit Test
on:
  workflow_dispatch:
  schedule:
    - cron: '30 1 * * *'
  push:
    branches:
      - chore/fix-nightly-repeated-test

permissions:
    contents: read

concurrency:
  group: ${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  unit_tests:
    name: ${{ matrix.scheme }} Repeated Unit Tests
    strategy:
      fail-fast: false
      matrix:
        scheme: [
          Amplify,
          AWSPluginsCore,
          AWSAPIPlugin,
          AWSCloudWatchLoggingPlugin,
          AWSCognitoAuthPlugin,
          AWSDataStorePlugin,
          AWSLocationGeoPlugin,
          AWSPredictionsPlugin,
          AWSPinpointAnalyticsPlugin,
          AWSPinpointPushNotificationsPlugin,
          AWSS3StoragePlugin,
          CoreMLPredictionsPlugin,
          InternalAWSPinpointUnitTests
        ]
    uses: ./.github/workflows/run_unit_tests_platforms.yml
    with:
      scheme: ${{ matrix.scheme }}
      timeout-minutes: 120
      generate_coverage_report: false
      test_iterations_flags: -test-iterations 5 
        -skip-testing AWSDataStoreCategoryPluginTests/StorageEngineTestsSQLiteIndex 
        -skip-testing CoreMLPredictionsPluginUnitTests/CoreMLNaturalLanguageAdapterTests/testEntityToken 
        -skip-testing CoreMLPredictionsPluginUnitTests/CoreMLNaturalLanguageAdapterTests/testSyntaxToken 
        -skip-testing InternalAWSPinpointUnitTests/EventRecorderTests/testSubmitAllEvents_withActiveAndStoppedSessions_shouldGenerateRightInput 
        -skip-testing InternalAWSPinpointUnitTests/SessionClientTests/testApplicationTerminated_shouldRecordStopEvent_andSaveSession 
        -skip-testing InternalAWSPinpointUnitTests/AnalyticsClientTests/testRecord_shouldAddGlobalAttributesAndMetrics 
        -skip-testing InternalAWSPinpointUnitTests/AnalyticsEventStorageTests/testGetEventsWithLimit 
        -skip-testing InternalAWSPinpointUnitTests/AnalyticsEventStorageTests/testRemoveFailedEvents
        -skip-testing InternalAWSPinpointUnitTests/AnalyticsEventStorageTests/testInvalidDeleteEvent
        -skip-testing InternalAWSPinpointUnitTests/AnalyticsEventStorageTests/testDeleteEvent
        -skip-testing InternalAWSPinpointUnitTests/PinpointClientTypesCodableTests/testCodableTypes_shouldEncodeAndDecodeSuccesfully 
        -skip-testing AWSS3StoragePluginTests/AWSS3StorageDownloadDataOperationTests/testDownloadDataOperationDownloadDataFailed 
        -skip-testing AWSS3StoragePluginTests/DefaultStorageTransferDatabaseTests/testLoadPersistableTasks 
        -skip-testing AWSS3StoragePluginTests/DefaultStorageTransferDatabaseTests/testPrepareForBackground 
        -skip-testing AWSS3StoragePluginTests/AWSS3StorageUploadFileOperationTests/testUploadFileOperationStringStoragePathValidationError 
        -skip-testing AWSPinpointPushNotificationsPluginUnitTests/AWSPinpointPushNotificationsPluginConfigureTests/testPluginKey
        -skip-testing AWSPinpointPushNotificationsPluginUnitTests/AWSPinpointPushNotificationsPluginConfigureTests/testConfigure_withNotificationsPermissionsDenied_shouldReportFailureToHub
        -skip-testing AWSPinpointAnalyticsPluginUnitTests/AWSPinpointAnalyticsPluginClientBehaviorTests/testIdentifyUserDispatchesErrorForPinpointError 
        -skip-testing AWSPinpointAnalyticsPluginUnitTests/AWSPinpointAnalyticsPluginClientBehaviorTests/testRecordEventWithNameDispatchesErrorForPinpointError 
        -skip-testing AWSPinpointAnalyticsPluginUnitTests/AWSPinpointAnalyticsPluginClientBehaviorTests/testRecordEventWithName
        -skip-testing AWSDataStoreCategoryPluginTests/MutationEventExtensionsTest/testSentModelVersionNewerThanResponseVersion_PendingEventNotReconciled 
        -skip-testing AWSDataStoreCategoryPluginTests/ObserveQueryTaskRunnerTests/testGenerateSnapshotOnObserveQueryWhenModelSynced 
        -skip-testing AWSDataStoreCategoryPluginTests/ObserveQueryTaskRunnerTests/testItemChangedWillGenerateSnapshot 
        -skip-testing AWSDataStoreCategoryPluginTests/ObserveQueryTaskRunnerTests/testSuccess
        -skip-testing AWSDataStoreCategoryPluginTests/OutgoingMutationQueueTests/testMutationQueueCreateSendsSync 
        -skip-testing AWSDataStoreCategoryPluginTests/OutgoingMutationQueueTests/testMutationQueueDeliversPendingMutationsFirst 
        -skip-testing AWSDataStoreCategoryPluginTests/LocalSubscriptionTests/testObserve 
        -skip-testing AWSDataStoreCategoryPluginTests/SyncMutationToCloudOperationTests/testRetryOnChangeReachability 
        -skip-testing AWSDataStoreCategoryPluginTests/MutationEventExtensionsTest/testPendingVersionReconciledSuccess 
        -skip-testing AWSDataStoreCategoryPluginTests/MutationEventExtensionsTest/testSentModelNotEqualToResponseModel_PendingEventNotReconciled 
        -skip-testing AWSCognitoAuthPluginUnitTests/AWSCognitoAuthPluginAmplifyOutputsConfigTests/testConfigWithOnlyUserPool 
        -skip-testing AWSCognitoAuthPluginUnitTests/AWSCognitoAuthPluginAmplifyOutputsConfigTests/testConfigWithUserPoolAndIdentityPoolWithNetworkPreferencesAndSecureStoragePreferences 
        -skip-testing AWSCognitoAuthPluginUnitTests/AWSAuthResendSignUpCodeAPITests/testResendSignupCodeWithEmptyUsername
        -skip-testing AWSCognitoAuthPluginUnitTests/StateMachineListenerTests/testOrderOfSubsription
        -skip-testing AWSCognitoAuthPluginUnitTests/AWSAuthSignInPluginTests/testSignInWithInvalidResult 
        -skip-testing AWSCloudWatchLoggingPluginTests/AWSCloudWatchLoggingMonitorTests/testDelegateIsInvokedOnInterval 
        -skip-testing AWSCloudWatchLoggingPluginTests/AWSCloudWatchLoggingSessionControllerTests/testConsumeFailureSendsHubEvent 
        -skip-testing AWSAPIPluginTests/AppSyncRealTimeClientTests/testSendRequestWithTimeout_withErrorResponse_triggerErrorForUnknow 
        -skip-testing AWSAPIPluginTests/AppSyncRealTimeClientTests/testSendRequestWithTimeout_withErrorResponse_transformLimitExceededError 
        -skip-testing AWSAPIPluginTests/AppSyncRealTimeClientTests/AppSyncRealTimeClientTests/testSendRequestWithTimeout_withCorrectResponse_succeed 
        -skip-testing AWSAPIPluginTests/GraphQLSubscribeTests/testDecodingError 
        -skip-testing AWSAPIPluginTests/AWSGraphQLOperationTests/testOperationCleanup 
        -skip-testing AWSAPIPluginTests/GraphQLSubscribeCombineTests/testMixedSuccessAndErrorValues 
        -skip-testing AWSAPIPluginTests/GraphQLSubscribeCombineTests/testMultipleSuccessValues
        -skip-testing AWSAPIPluginTests/GraphQLSubscribeTasksTests/testDecodingError
        -skip-testing AWSAPIPluginTests/GraphQLSubscribeTests/testConnectionWithNoData
        -skip-testing AWSAPIPluginTests/AWSAPICategoryPluginRESTClientBehaviorTests/testGet
        -skip-testing AWSPluginsCoreTests/WebSocketClientTests/testAutoRetry_whenReceiveTransientFailureFromServer
        -skip-testing AmplifyTests/AmplifyTaskTests/testLongOperationWithPublishers
      test_without_building: true
      retry_tests: false
