name: Amplify Nightly Repeated Unit Test
on:
  workflow_dispatch:
  schedule:
    - cron: '30 1 * * *'
  push:
    branches:
      - chore/fix-nightly-repeated-test

permissions:
    contents: read

concurrency:
  group: ${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  unit_tests:
    name: ${{ matrix.scheme }} Repeated Unit Tests
    strategy:
      fail-fast: false
      matrix:
        scheme: [
          Amplify,
          AWSPluginsCore,
          AWSAPIPlugin,
          AWSCloudWatchLoggingPlugin,
          AWSCognitoAuthPlugin,
          AWSDataStorePlugin,
          AWSLocationGeoPlugin,
          AWSPredictionsPlugin,
          AWSPinpointAnalyticsPlugin,
          AWSPinpointPushNotificationsPlugin,
          AWSS3StoragePlugin,
          CoreMLPredictionsPlugin,
          InternalAWSPinpointUnitTests
        ]
    uses: ./.github/workflows/run_unit_tests_platforms.yml
    with:
      scheme: ${{ matrix.scheme }}
      timeout-minutes: 120
      generate_coverage_report: false
      test_iterations_flags: -test-iterations 5 -parallel-testing-enabled NO -test-repetition-relaunch-enabled YES
        -skip-testing AWSDataStoreCategoryPluginTests/StorageEngineTestsSQLiteIndex        
        -skip-testing CoreMLPredictionsPluginUnitTests/CoreMLNaturalLanguageAdapterTests/testEntityToken 
        -skip-testing CoreMLPredictionsPluginUnitTests/CoreMLNaturalLanguageAdapterTests/testSyntaxToken 
        -skip-testing AWSS3StoragePluginTests/AWSS3StorageDownloadFileOperationTests
        -skip-testing AWSS3StoragePluginTests/DefaultStorageTransferDatabaseTests
        -skip-testing AWSS3StoragePluginTests/AWSS3StorageDownloadDataOperationTests
        -skip-testing AWSS3StoragePluginTests/AWSS3StorageUploadFileOperationTests
        -skip-testing AWSS3StoragePluginTests/AWSS3StorageServiceTests
        -skip-testing AWSPinpointAnalyticsPluginUnitTests/AWSPinpointAnalyticsPluginClientBehaviorTests
        -skip-testing AWSDataStoreCategoryPluginTests/ModelReconciliationQueueBehaviorTests
        -skip-testing AWSDataStoreCategoryPluginTests/OutgoingMutationQueueTests
        -skip-testing AWSDataStoreCategoryPluginTests/MutationEventExtensionsTest
        -skip-testing AWSDataStoreCategoryPluginTests/ObserveQueryTaskRunnerTests
        -skip-testing AWSDataStoreCategoryPluginTests/SyncMutationToCloudOperationTests
        -skip-testing AWSDataStoreCategoryPluginTests/LocalSubscriptionTests
        -skip-testing AWSDataStoreCategoryPluginTests/InitialSyncOrchestratorTests
        -skip-testing AWSDataStoreCategoryPluginTests/LocalSubscriptionWithJSONModelTests
        -skip-testing AWSDataStoreCategoryPluginTests/AWSDataStoreLocalStoreTests
        -skip-testing AWSDataStoreCategoryPluginTests/OutgoingMutationQueueMockStateTest
        -skip-testing AWSDataStoreCategoryPluginTests/AWSDataStorePluginBaseBehaviorTests
        -skip-testing AWSDataStoreCategoryPluginTests/AWSDataStorePluginSubscribeBehaviorTests
        -skip-testing AWSDataStoreCategoryPluginTests/CascadeDeleteOperationTests
        -skip-testing AWSDataStoreCategoryPluginTests/InitialSyncOperationTests
        -skip-testing AWSCognitoAuthPluginUnitTests/DeviceBehaviorForgetDeviceTests
        -skip-testing AWSCognitoAuthPluginUnitTests/AWSCognitoAuthPluginConfigTests
        -skip-testing AWSCognitoAuthPluginUnitTests/AWSCognitoAuthPluginAmplifyOutputsConfigTests
        -skip-testing AWSCognitoAuthPluginUnitTests/AWSAuthSignOutTaskTests
        -skip-testing AWSCognitoAuthPluginUnitTests/ClientBehaviorResetPasswordTests
        -skip-testing AWSCognitoAuthPluginUnitTests/DeviceBehaviorFetchDevicesTests
        -skip-testing AWSCognitoAuthPluginUnitTests/AWSAuthSignUpAPITests
        -skip-testing AWSCognitoAuthPluginUnitTests/VerifyTOTPSetupTaskTests
        -skip-testing AWSCognitoAuthPluginUnitTests/AWSCognitoAuthUserBehaviorTests
        -skip-testing AWSCognitoAuthPluginUnitTests/AuthenticationProviderConfirmSigninTests
        -skip-testing AWSCognitoAuthPluginUnitTests/StateMachineListenerTests
        -skip-testing AWSCognitoAuthPluginUnitTests/AuthenticationProviderDeleteUserTests
        -skip-testing AWSCognitoAuthPluginUnitTests/UpdateMFAPreferenceTaskTests
        -skip-testing AWSCognitoAuthPluginUnitTests/DeviceBehaviorRememberDeviceTests
        -skip-testing AWSCognitoAuthPluginUnitTests/SendUserAttributeVerificationCodeTests
        -skip-testing AWSCloudWatchLoggingPluginTests/AWSCloudWatchLoggingMonitorTests
        -skip-testing AWSCloudWatchLoggingPluginTests/AWSCloudWatchLoggingSessionControllerTests
        -skip-testing AWSAPIPluginTests/AppSyncRealTimeClientTests
        -skip-testing AWSAPIPluginTests/GraphQLSubscribeTasksTests
        -skip-testing AWSAPIPluginTests/AWSAPICategoryPluginGraphQLBehaviorTests
        -skip-testing AWSAPIPluginTests/AppSyncListProviderTests
        -skip-testing AWSAPIPluginTests/AWSGraphQLOperationTests
        -skip-testing AWSAPIPluginTests/GraphQLSubscribeCombineTests
        -skip-testing AWSAPIPluginTests/GraphQLSubscribeTests
        -skip-testing AWSAPIPluginTests/AWSRESTOperationTests
        -skip-testing InternalAWSPinpointUnitTests/SessionClientTests
        -skip-testing InternalAWSPinpointUnitTests/AWSAPICategoryPluginRESTClientBehaviorTests
        -skip-testing AWSPluginsCoreTests/WebSocketClientTests
      test_without_building: true
      retry_tests: false
